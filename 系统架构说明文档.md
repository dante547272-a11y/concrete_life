# 无人拌合站系统架构说明文档

## 文档信息
- **项目名称**: 无人拌合站智能管理系统
- **架构模式**: 云边端协同架构
- **版本**: V2.0
- **编制日期**: 2026年2月5日
- **系统状态**: 后端已完成，前端开发中

---

## 目录

1. [系统概述](#一系统概述)
2. [云边端架构设计](#二云边端架构设计)
3. [系统整体架构](#三系统整体架构)
4. [核心模块架构](#四核心模块架构)
5. [数据库设计](#五数据库设计)
6. [API设计规范](#六api设计规范)
7. [实时通信架构](#七实时通信架构)
8. [前端架构设计](#八前端架构设计)
9. [边缘网关实施](#九边缘网关实施)
10. [云端服务实施](#十云端服务实施)
11. [云边协同场景](#十一云边协同场景)
12. [安全架构](#十二安全架构)
13. [性能优化](#十三性能优化)
14. [部署架构](#十四部署架构)
15. [监控与运维](#十五监控与运维)

---

## 一、系统概述

### 1.1 项目背景

本系统是为混凝土搅拌站打造的全流程智能化管理平台，采用**云边端协同架构**，实现从原材料管理、生产控制到成品运输的无人化、智能化管理。

### 1.2 技术栈总览

**后端技术栈**:
- 框架: NestJS (Node.js)
- 数据库: SQLite (开发) / PostgreSQL (生产)
- ORM: Prisma
- 认证: JWT
- 实时通信: WebSocket (Socket.io)
- 缓存: Redis

**前端技术栈**:
- 框架: React 19 + TypeScript
- UI组件: Ant Design 6
- 状态管理: Zustand
- 数据请求: Axios + TanStack Query
- 路由: React Router 7
- 图表: ECharts
- 地图: Leaflet
- 实时通信: Socket.io-client

**边缘计算**:
- 运行时: Node.js 18 / Python 3.9
- 容器: Docker + Docker Compose
- 数据库: SQLite
- 缓存: Redis
- 消息队列: Mosquitto MQTT

---

## 二、云边端架构设计

### 2.1 什么是云边端架构

云边端架构是一种分布式计算架构，将计算、存储和智能分布在三个层次：

```
┌─────────────────────────────────────────────────────────────┐
│                        云端 (Cloud)                          │
│  - 中心化管理                                                │
│  - 大数据分析                                                │
│  - AI模型训练                                                │
│  - 跨站点协同                                                │
└────────────────────────┬────────────────────────────────────┘
                         │ 互联网/专线
┌────────────────────────▼────────────────────────────────────┐
│                        边缘 (Edge)                           │
│  - 本地计算                                                  │
│  - 实时处理                                                  │
│  - 协议转换                                                  │
│  - 断网续传                                                  │
└────────────────────────┬────────────────────────────────────┘
                         │ 工业网络
┌────────────────────────▼────────────────────────────────────┐
│                        端侧 (Device)                         │
│  - 数据采集                                                  │
│  - 设备控制                                                  │
│  - 传感器                                                    │
│  - 执行器                                                    │
└─────────────────────────────────────────────────────────────┘
```

### 2.2 为什么需要云边端架构

#### 现状：完全本地化架构的问题

**当前系统特点**:
- 所有功能部署在本地服务器
- 数据完全存储在本地数据库
- 无云端备份和同步
- 单点部署，无分布式能力

**存在的问题**:
- ❌ 数据孤岛：各站点数据无法统一管理和分析
- ❌ 扩展困难：新增站点需要重复部署整套系统
- ❌ 维护成本高：需要逐个站点进行系统升级和维护
- ❌ 数据安全风险：本地硬件故障可能导致数据永久丢失
- ❌ 无法远程监控：管理层无法实时查看各站点运营状况
- ❌ 缺乏数据分析：无法进行跨站点的数据统计和业务分析
- ❌ 资源利用率低：每个站点独立配置服务器，资源浪费

#### 云边端架构的优势

**架构特点**:
- 云端：集中管理、数据分析、远程监控
- 边缘：本地计算、实时处理、离线可用
- 端侧：数据采集、设备控制

**核心优势**:
- ✅ 低延迟（<10ms）：边缘层本地处理，实时响应
- ✅ 离线可用：断网情况下业务不中断
- ✅ 降低带宽成本：只上传必要数据到云端
- ✅ 数据本地化：敏感数据可留在边缘层
- ✅ 实时响应：关键业务在边缘层完成
- ✅ 智能分布：计算任务合理分配
- ✅ 统一管理：云端集中管理所有站点
- ✅ 数据备份：云端自动备份，防止数据丢失
- ✅ 远程运维：云端远程监控和升级
- ✅ 数据分析：跨站点数据统计和BI分析

### 2.3 端侧层 (Device Layer)

#### 端侧设备分类

**传感器设备**:
- 车牌识别摄像头（2台，HTTP API，实时）
- 称重传感器（1台，Modbus，1秒/次）
- 激光雷达（4台，TCP，5分钟/次）
- 料位传感器（8台，Modbus，30秒/次）
- 温度传感器（8台，RS485，30秒/次）
- AI摄像头（4台，RTSP，10fps）
- GPS定位模块（10台，4G，10秒/次）

**执行器设备**:
- LED显示屏（2块，HTTP）
- 语音播报器（2套，HTTP）
- 信号灯（2套，GPIO）
- 电磁阀（12个，Modbus）
- 变频器（4台，Modbus）

### 2.4 边缘层 (Edge Layer)

**边缘网关架构**:
```
┌─────────────────────────────────────────────────────────────┐
│                      边缘计算网关                            │
├─────────────────────────────────────────────────────────────┤
│  数据采集层 → 协议转换层 → 数据处理层                       │
│                      ↓                                       │
│              边缘计算引擎                                    │
│      (实时计算 + AI推理 + 规则引擎)                         │
│                      ↓                                       │
│          本地存储(SQLite) + 本地缓存(Redis)                 │
│                      ↓                                       │
│              通信管理层                                      │
│      (上行通信 + 下行控制 + 断网续传)                       │
└─────────────────────────────────────────────────────────────┘
```

**核心功能**:
1. **协议转换**: Modbus/MQTT/OPC UA → HTTP JSON
2. **数据预处理**: 清洗、聚合、压缩
3. **边缘计算**: 库存计算、AI推理、规则引擎
4. **断网续传**: 本地缓存、自动重传

### 2.5 云端层 (Cloud Layer)

**云端架构**:
```
应用服务层 (Web/移动端/大屏)
        ↓
API网关层 (认证/限流/日志/监控)
        ↓
业务逻辑层 (订单/生产/设备/分析)
        ↓
数据服务层 (PostgreSQL/Redis/InfluxDB)
        ↓
大数据分析层 (数据仓库/离线分析/AI训练)
```

**核心功能**:
1. **中心化管理**: 多站点统一管理、权限控制
2. **大数据分析**: 跨站点分析、趋势预测
3. **AI模型训练**: 模型训练、模型下发
4. **跨站点协同**: 资源调度、数据共享

### 2.6 任务分配原则

| 任务类型 | 执行层 | 原因 |
|---------|--------|------|
| 实时控制 | 端侧/边缘 | 低延迟要求 |
| 数据采集 | 端侧 | 靠近数据源 |
| 协议转换 | 边缘 | 减轻云端负担 |
| AI推理 | 边缘 | 实时响应 |
| 数据存储 | 云端 | 大容量需求 |
| 大数据分析 | 云端 | 计算密集 |
| AI训练 | 云端 | 算力需求高 |
| 跨站点协同 | 云端 | 中心化管理 |

---

## 三、系统整体架构

### 3.1 整体架构图

```
┌─────────────────────────────────────────────────────────────┐
│                      前端应用层                              │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │  Web管理端   │  │  移动端小程序 │  │  大屏展示端   │      │
│  │  (React)     │  │  (微信小程序) │  │  (数据可视化) │      │
│  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘      │
└─────────┼──────────────────┼──────────────────┼─────────────┘
          │    HTTP/HTTPS    │   WebSocket      │
┌─────────▼──────────────────▼──────────────────▼─────────────┐
│                      API网关层                               │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │  JWT认证     │  │  权限控制     │  │  日志拦截     │      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
└─────────────────────────────┬───────────────────────────────┘
┌─────────────────────────────▼───────────────────────────────┐
│                      业务逻辑层 (NestJS)                     │
│  原材料管理 | 生产控制 | 成品运输                            │
│  订单管理 | 设备管理 | 质量追溯                              │
│  告警系统 | 数据分析 | 报表管理                              │
└─────────────────────────────┬───────────────────────────────┘
┌─────────────────────────────▼───────────────────────────────┐
│                      数据访问层                              │
│  Prisma ORM | Redis缓存 | 文件存储                          │
└─────────────────────────────┬───────────────────────────────┘
┌─────────────────────────────▼───────────────────────────────┐
│              SQLite/PostgreSQL | Redis Server                │
└─────────────────────────────────────────────────────────────┘
```

### 3.2 硬件集成架构

```
┌─────────────────────────────────────────────────────────────┐
│                      物联网设备层                            │
│  车牌识别 | 激光雷达 | AI摄像头                              │
│  称重传感器 | 料位传感器 | 温度传感器                        │
│  GPS定位 | 红外检测 | 物联网秤                              │
└─────────────────────────────┬───────────────────────────────┘
                              │ MQTT/TCP/HTTP
┌─────────────────────────────▼───────────────────────────────┐
│                      边缘计算层                              │
│  数据清洗 | 协议转换 | 数据缓存                              │
│  AI推理 | 实时计算 | 断网续传                                │
└─────────────────────────────┬───────────────────────────────┘
                              │ HTTPS/WebSocket
┌─────────────────────────────▼───────────────────────────────┐
│                      云端服务层                              │
│  数据存储 | 业务处理 | 大数据分析                            │
└─────────────────────────────────────────────────────────────┘
```

---

## 四、核心模块架构

### 4.1 原材料管理模块

**智能磅房系统**:
- 后端: `materials` + `inventory` 模块
- 前端: `MaterialsPage`
- 硬件: 车牌识别 + 称重传感器
- 功能: 自动称重、电子票据、库存管理

**智能仓储管理**:
- 后端: `MaterialStock` 表 + WebSocket推送
- 前端: 三维可视化 + 实时告警
- 硬件: 激光雷达 + 料位传感器 + 温度传感器
- 功能: 点云建模、库存监控、智能预警

### 4.2 生产控制模块

- 后端: `production`, `recipes`, `grades` 模块
- 前端: `ProductionControlPage`, `RecipesPage`
- 功能: 配方管理、批次生产、配料记录、自动矫正

### 4.3 成品运输模块

**智能装车系统**:
- 后端: `tasks`, `orders`, `queue` 模块
- 前端: `QueuePage`, `TasksPage`
- 硬件: AI摄像头 + LED显示屏
- 功能: 车辆对位、防溢料检测、智能调度

**电子开单与信息传递**:
- 功能: 电子票据、GPS轨迹、温度监控

---

## 五、数据库设计

### 5.1 核心数据表

| 表名 | 说明 | 关键字段 |
|------|------|---------|
| Site | 站点信息 | id, name, code, status |
| User | 用户信息 | id, username, userType, siteId |
| Equipment | 设备信息 | id, equipmentType, status |
| Material | 物料信息 | id, name, type, lowThreshold |
| MaterialStock | 库存信息 | materialId, currentStock, capacity |
| Recipe | 配方信息 | id, concreteGrade, version |
| Orders | 订单信息 | orderNumber, status, totalVolume |
| Task | 任务信息 | taskNumber, status, equipmentId |
| ProductionBatch | 生产批次 | batchNumber, recipeId, volume |
| Queue | 排队信息 | queueNumber, status, equipmentId |
| Alarm | 告警记录 | alarmType, severity, acknowledged |

### 5.2 数据关系

```
Site (1) ──── (N) User
Site (1) ──── (N) Equipment
Site (1) ──── (N) Material
Material (1) ──── (1) MaterialStock
Recipe (1) ──── (N) RecipeItem ──── (N) Material
Orders (1) ──── (N) Task
Task (1) ──── (N) ProductionBatch
ProductionBatch (1) ──── (N) BatchingRecord
Equipment (1) ──── (N) Queue
```

---

## 六、API设计规范

### 6.1 RESTful API规范

**基础URL**: `http://localhost:3001/api`
**认证方式**: JWT Bearer Token
**数据格式**: JSON

**响应格式**:
```json
{
  "success": true,
  "data": {},
  "message": "操作成功",
  "timestamp": "2026-02-05T10:00:00Z"
}
```

### 6.2 核心API端点

**认证模块**:
- POST /auth/register - 用户注册
- POST /auth/login - 用户登录
- GET /auth/profile - 获取用户信息

**物料管理**:
- POST /materials - 创建物料
- GET /materials - 查询物料列表
- POST /inventory/transactions - 记录出入库

**生产管理**:
- POST /production/batches - 创建生产批次
- POST /production/batches/:id/start - 开始生产
- GET /production/statistics - 生产统计

**订单任务**:
- POST /orders - 创建订单
- PATCH /orders/:id/status - 更新订单状态
- POST /tasks - 创建任务

**告警系统**:
- GET /alarms - 查询告警列表
- PATCH /alarms/:id/acknowledge - 确认告警

---

## 七、实时通信架构

### 7.1 WebSocket设计

**连接地址**: `ws://localhost:3001`
**认证方式**: JWT Token

**房间订阅**:
```typescript
socket.emit('subscribe', { 
  room: 'site_1',
  events: ['alarm', 'production', 'queue']
});
```

### 7.2 实时事件类型

- alarm:new - 新告警
- alarm:update - 告警更新
- production:update - 生产更新
- queue:update - 排队更新
- material:low - 低库存
- equipment:status - 设备状态

---

## 八、前端架构设计

### 8.1 技术栈

- React 19 + TypeScript
- Ant Design 6
- Zustand (状态管理)
- TanStack Query (数据请求)
- ECharts (图表)
- Leaflet (地图)

### 8.2 目录结构

```
src/
├── components/     # 公共组件
├── pages/          # 页面组件
├── stores/         # 状态管理
├── hooks/          # 自定义Hooks
├── utils/          # 工具函数
└── styles/         # 样式文件
```

---

## 九、边缘网关实施

### 9.1 硬件配置

- 型号: 研华 UNO-2483G
- CPU: Intel Core i5
- 内存: 8GB DDR4
- 存储: 128GB SSD
- 网络: 2x Gigabit Ethernet
- 串口: 4x RS232/485

### 9.2 软件栈

- 操作系统: Ubuntu 20.04 LTS
- 容器: Docker + Docker Compose
- 运行时: Node.js 18 / Python 3.9
- 数据库: SQLite
- 缓存: Redis
- 消息队列: Mosquitto MQTT

### 9.3 核心功能实现

**协议转换**:
- Modbus TCP/RTU → HTTP JSON
- MQTT → HTTP JSON
- OPC UA → HTTP JSON

**边缘计算**:
- 库存计算（点云处理）
- AI推理（车辆检测）
- 规则引擎（告警判断）

**断网续传**:
- 本地缓存队列
- 自动重传机制
- 数据持久化

---

## 十、云端服务实施

### 10.1 时序数据库

使用 **InfluxDB** 存储传感器数据:
- 原始数据保留7天
- 1分钟聚合数据保留30天
- 1小时聚合数据保留1年

### 10.2 大数据分析

**数据仓库设计**:
- 事实表: 生产批次、订单、库存变动
- 维度表: 日期、站点、物料、设备

**分析功能**:
- 跨站点生产分析
- 预测性维护
- 趋势预测

---

## 十一、云边协同场景

### 11.1 智能装车场景

**流程**:
1. 端侧: AI摄像头采集车辆图像
2. 边缘: 实时AI推理，计算车辆位置
3. 边缘: 生成引导指令，控制LED显示
4. 边缘: 判断对位完成，触发装车
5. 云端: 记录装车数据，更新订单状态
6. 云端: WebSocket推送到前端

### 11.2 库存监控场景

**流程**:
1. 端侧: 激光雷达扫描料仓
2. 边缘: 点云处理，计算库存量
3. 边缘: 判断是否低于阈值
4. 边缘: 触发本地告警
5. 云端: 记录库存变化
6. 云端: 生成采购建议
7. 云端: 推送告警到管理员

### 11.3 预测性维护场景

**流程**:
1. 端侧: 设备传感器持续采集数据
2. 边缘: 数据预处理，异常检测
3. 边缘: 定期上传设备数据到云端
4. 云端: 大数据分析，AI模型预测
5. 云端: 生成维护建议
6. 云端: 推送到维护人员

---

## 十二、安全架构

### 12.1 认证授权

**JWT认证流程**:
1. 用户登录 → 验证用户名密码
2. 生成JWT Token (有效期1小时)
3. 返回Token + RefreshToken (有效期7天)
4. 客户端存储Token
5. 每次请求携带Token
6. 服务端验证Token
7. Token过期 → 使用RefreshToken刷新

**权限控制**:
- 基于角色的访问控制 (RBAC)
- 路由守卫 (前端)
- API守卫 (后端)

### 12.2 数据安全

- 密码加密: bcrypt
- 数据传输: HTTPS/TLS
- SQL注入防护: Prisma ORM
- XSS防护: 输入验证 + 输出转义
- CSRF防护: Token验证

### 12.3 网络安全

- 传输加密: TLS 1.3
- 证书认证: 双向认证
- VPN隧道: 远程访问
- IP白名单: 访问控制
- 防火墙: 端口限制

---

## 十三、性能优化

### 13.1 后端优化

**数据库优化**:
- 索引优化 (主键、外键、查询字段)
- 查询优化 (分页、字段筛选)
- 连接池管理

**缓存策略**:
- Redis缓存热点数据
- 查询结果缓存 (5分钟)
- 会话缓存

**异步处理**:
- 异步日志记录
- 异步告警通知
- 消息队列

### 13.2 前端优化

**代码分割**:
- 路由懒加载
- 组件按需加载
- 第三方库按需引入

**资源优化**:
- 图片压缩
- 静态资源CDN
- Gzip压缩

**渲染优化**:
- 虚拟列表
- 防抖节流
- React.memo

---

## 十四、部署架构

### 14.1 开发环境

```
开发机器
├── Node.js
├── SQLite
└── Redis
```

### 14.2 生产环境

```
负载均衡器 (Nginx)
├── 应用服务器1 (NestJS + PM2)
├── 应用服务器2 (NestJS + PM2)
└── 数据库服务器
    ├── PostgreSQL (主从)
    └── Redis (集群)
```

### 14.3 Docker部署

```yaml
services:
  api:
    image: concrete-plant-api
    ports: ["3001:3001"]
  web:
    image: concrete-plant-web
    ports: ["80:80"]
  postgres:
    image: postgres:14
  redis:
    image: redis:7
```

---

## 十五、监控与运维

### 15.1 系统监控

**应用监控**:
- API响应时间
- 错误率统计
- 并发连接数

**资源监控**:
- CPU使用率
- 内存使用率
- 磁盘空间

**业务监控**:
- 生产批次数
- 订单完成率
- 设备在线率

### 15.2 日志管理

**日志分类**:
- 访问日志 (Access Log)
- 错误日志 (Error Log)
- 业务日志 (Business Log)
- 审计日志 (Audit Log)

**日志存储**:
- 数据库存储
- 文件存储
- 日志聚合 (ELK Stack)

### 15.3 告警监控

**Prometheus + Grafana**:
- 边缘网关监控
- 云端服务监控
- 数据库监控
- 网络监控

---

## 十六、技术选型说明

### 16.1 为什么选择NestJS?

- ✅ TypeScript原生支持
- ✅ 模块化架构清晰
- ✅ 依赖注入容器
- ✅ 装饰器语法优雅
- ✅ 内置WebSocket支持
- ✅ 丰富的生态系统

### 16.2 为什么选择云边端架构?

- ✅ 低延迟实时响应
- ✅ 离线可用性
- ✅ 降低带宽成本
- ✅ 数据本地化
- ✅ 智能分布式计算

---

## 十七、总结

本系统采用**云边端协同架构**，具备以下特点:

1. **分布式智能**: 端侧采集、边缘计算、云端分析
2. **实时响应**: 边缘AI推理，延迟<10ms
3. **离线可用**: 断网续传，本地缓存
4. **模块化**: 清晰的模块划分，易于维护
5. **类型安全**: 全栈TypeScript
6. **高性能**: 缓存、索引、异步处理
7. **安全性**: JWT认证、权限控制、数据加密
8. **易部署**: Docker容器化

系统已完成后端开发和测试，前端开发进行中，可满足无人拌合站的智能化管理需求。

---

**文档版本**: V2.0  
**最后更新**: 2026年2月5日  
**编制说明**: 本文档整合了系统架构、云边端架构和实施方案
