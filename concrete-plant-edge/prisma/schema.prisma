// 边缘计算节点数据库模型
// Edge Computing Node Database Schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// ============================================================================
// 本地配置和状态管理
// ============================================================================

// 节点配置
model EdgeConfig {
  id          Int      @id @default(autoincrement())
  key         String   @unique // 配置键
  value       String   // 配置值
  description String?  // 描述
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@map("edge_config")
}

// 设备连接状态
model DeviceConnection {
  id           Int      @id @default(autoincrement())
  deviceType   String   @map("device_type") // modbus, opcua, ethernet_ip
  deviceId     String   @map("device_id") // 设备标识
  host         String   // 主机地址
  port         Int?     // 端口
  status       String   @default("disconnected") // connected, disconnected, error
  lastConnect  DateTime? @map("last_connect")
  errorMessage String?  @map("error_message")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  @@map("device_connections")
}

// ============================================================================
// 实时数据存储
// ============================================================================

// 实时数据点
model DataPoint {
  id          Int      @id @default(autoincrement())
  tagName     String   @map("tag_name") // 数据点标签名
  deviceId    String   @map("device_id") // 设备ID
  address     String   // PLC地址
  dataType    String   @map("data_type") // int, float, bool, string
  value       String   // 当前值（字符串存储）
  quality     String   @default("good") // good, bad, uncertain
  timestamp   DateTime @default(now())
  description String?  // 描述

  // 关联的历史数据
  history DataHistory[]

  @@unique([tagName, deviceId])
  @@map("data_points")
}

// 历史数据
model DataHistory {
  id        Int      @id @default(autoincrement())
  pointId   Int      @map("point_id")
  value     String   // 历史值
  quality   String   @default("good")
  timestamp DateTime @default(now())

  // 关联数据点
  dataPoint DataPoint @relation(fields: [pointId], references: [id], onDelete: Cascade)

  @@index([pointId, timestamp])
  @@map("data_history")
}

// ============================================================================
// 生产控制
// ============================================================================

// 本地配方
model LocalRecipe {
  id            Int      @id @default(autoincrement())
  name          String   // 配方名称
  concreteGrade String   @map("concrete_grade") // 混凝土等级
  version       String   @default("v1.0") // 版本
  isActive      Boolean  @default(false) @map("is_active") // 是否激活
  recipeData    String   @map("recipe_data") // 配方数据（JSON）
  syncStatus    String   @default("local") @map("sync_status") // local, synced, modified
  remoteId      Int?     @map("remote_id") // 远程配方ID
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  // 关联的生产批次
  batches LocalBatch[]

  @@map("local_recipes")
}

// 本地生产批次
model LocalBatch {
  id           Int       @id @default(autoincrement())
  batchNumber  String    @unique @map("batch_number") // 批次号
  recipeId     Int       @map("recipe_id") // 配方ID
  volume       Float     // 方量
  status       String    @default("preparing") // preparing, mixing, completed, failed
  startTime    DateTime? @map("start_time")
  endTime      DateTime? @map("end_time")
  operatorName String?   @map("operator_name") // 操作员姓名
  syncStatus   String    @default("local") @map("sync_status") // local, synced
  remoteId     Int?      @map("remote_id") // 远程批次ID
  createdAt    DateTime  @default(now()) @map("created_at")

  // 关联配方
  recipe LocalRecipe @relation(fields: [recipeId], references: [id])

  // 关联的配料记录
  batchingRecords LocalBatchingRecord[]

  @@map("local_batches")
}

// 本地配料记录
model LocalBatchingRecord {
  id             Int     @id @default(autoincrement())
  batchId        Int     @map("batch_id")
  materialName   String  @map("material_name") // 原材料名称
  targetWeight   Float   @map("target_weight") // 目标重量
  actualWeight   Float   @map("actual_weight") // 实际重量
  deviation      Float?  // 偏差
  toleranceCheck String  @default("pass") @map("tolerance_check") // pass, warning, fail
  timestamp      DateTime @default(now())

  // 关联批次
  batch LocalBatch @relation(fields: [batchId], references: [id], onDelete: Cascade)

  @@map("local_batching_records")
}

// ============================================================================
// 告警和日志
// ============================================================================

// 本地告警
model LocalAlarm {
  id           Int       @id @default(autoincrement())
  alarmType    String    @map("alarm_type") // equipment, safety, quality, system
  source       String    // 告警源
  message      String    // 告警信息
  severity     String    // critical, warning, info
  acknowledged Boolean   @default(false) // 是否已确认
  resolved     Boolean   @default(false) // 是否已解决
  syncStatus   String    @default("local") @map("sync_status") // local, synced
  remoteId     Int?      @map("remote_id") // 远程告警ID
  timestamp    DateTime  @default(now())
  resolvedAt   DateTime? @map("resolved_at")

  @@map("local_alarms")
}

// 操作日志
model LocalLog {
  id         Int      @id @default(autoincrement())
  level      String   // debug, info, warn, error
  module     String   // 模块名
  action     String   // 操作动作
  message    String   // 日志信息
  data       String?  // 附加数据（JSON）
  syncStatus String   @default("local") @map("sync_status") // local, synced
  timestamp  DateTime @default(now())

  @@index([level, timestamp])
  @@map("local_logs")
}

// ============================================================================
// 同步管理
// ============================================================================

// 同步队列
model SyncQueue {
  id        Int      @id @default(autoincrement())
  type      String   // realtime, batch, alarm, log
  data      String   // 数据内容（JSON）
  status    String   @default("pending") // pending, syncing, completed, failed
  retryCount Int     @default(0) @map("retry_count")
  lastError String?  @map("last_error")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([status, createdAt])
  @@map("sync_queue")
}

// 同步状态
model SyncStatus {
  id            Int      @id @default(autoincrement())
  type          String   @unique // connection, data_sync, config_sync
  status        String   // online, offline, syncing, error
  lastSync      DateTime? @map("last_sync")
  lastError     String?  @map("last_error")
  syncCount     Int      @default(0) @map("sync_count")
  errorCount    Int      @default(0) @map("error_count")
  updatedAt     DateTime @updatedAt @map("updated_at")

  @@map("sync_status")
}

// ============================================================================
// 生产管理（新增）
// ============================================================================

// 配方表
model Recipe {
  id          String @id @default(cuid())
  name        String
  cement      Float
  water       Float
  sand        Float
  gravel      Float
  additive    Float
  mixingTime  Int    @map("mixing_time")
  enabled     Boolean @default(true)
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // 关联的生产任务
  productionTasks ProductionTask[]

  @@map("recipes")
}

// 生产任务
model ProductionTask {
  id        String @id @default(cuid())
  recipeId  String @map("recipe_id")
  quantity  Float
  priority  Int    @default(1)
  status    String @default("pending") // pending, running, completed, failed
  startTime DateTime? @map("start_time")
  endTime   DateTime? @map("end_time")
  createdAt DateTime @default(now()) @map("created_at")

  // 关联配方
  recipe Recipe @relation(fields: [recipeId], references: [id])

  // 关联的生产记录
  productionRecords ProductionRecord[]

  @@map("production_tasks")
}

// 生产记录
model ProductionRecord {
  id        String @id @default(cuid())
  taskId    String @map("task_id")
  recipeId  String @map("recipe_id")
  quantity  Float
  status    String // completed, failed
  startTime DateTime @map("start_time")
  endTime   DateTime @map("end_time")
  createdAt DateTime @default(now()) @map("created_at")

  // 关联任务
  task ProductionTask @relation(fields: [taskId], references: [id])

  @@map("production_records")
}

// ============================================================================
// 告警管理（新增）
// ============================================================================

// 告警表
model Alarm {
  id             String    @id @default(cuid())
  type           String
  source         String
  message        String
  severity       String    // low, medium, high, critical
  status         String    @default("active") // active, acknowledged, resolved
  data           String?   // JSON数据
  acknowledgedAt DateTime? @map("acknowledged_at")
  acknowledgedBy String?   @map("acknowledged_by")
  resolvedAt     DateTime? @map("resolved_at")
  resolvedBy     String?   @map("resolved_by")
  resolution     String?
  createdAt      DateTime  @default(now()) @map("created_at")

  @@map("alarms")
}

// ============================================================================
// 安全管理（新增）
// ============================================================================

// 安全事件
model SafetyEvent {
  id          String   @id @default(cuid())
  type        String   // emergency_stop, rule_violation, emergency_reset
  description String
  severity    String   // low, medium, high, critical
  data        String?  // JSON数据
  createdAt   DateTime @default(now()) @map("created_at")

  @@map("safety_events")
}

// 安全规则
model SafetyRule {
  id        String  @id @default(cuid())
  name      String
  type      String  // temperature, pressure, vibration, door, emergency, custom
  condition String  // greater_than, less_than, equals
  threshold Float
  action    String  // alarm, stop, emergency_stop
  enabled   Boolean @default(true)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("safety_rules")
}

// ============================================================================
// 系统监控（更新）
// ============================================================================

// 系统指标
model SystemMetrics {
  id        String   @id @default(cuid())
  type      String   // system, equipment
  data      String   // JSON数据
  timestamp DateTime @default(now())

  @@map("system_metrics")
}

// 设备运行时间
model EquipmentRuntime {
  id            String   @id @default(cuid())
  equipmentName String   @map("equipment_name")
  runtime       Float    // 运行时间（分钟）
  date          DateTime
  createdAt     DateTime @default(now()) @map("created_at")

  @@unique([equipmentName, date])
  @@map("equipment_runtime")
}

// 系统状态
model SystemStatus {
  id          Int      @id @default(autoincrement())
  cpuUsage    Float    @map("cpu_usage") // CPU使用率
  memoryUsage Float    @map("memory_usage") // 内存使用率
  diskUsage   Float    @map("disk_usage") // 磁盘使用率
  temperature Float?   // 系统温度
  uptime      Int      // 运行时间（秒）
  timestamp   DateTime @default(now())

  @@map("system_status")
}

// 设备状态统计
model DeviceStats {
  id              Int      @id @default(autoincrement())
  deviceId        String   @map("device_id")
  connectTime     Int      @default(0) @map("connect_time") // 连接时间（秒）
  disconnectTime  Int      @default(0) @map("disconnect_time") // 断开时间（秒）
  errorCount      Int      @default(0) @map("error_count") // 错误次数
  dataPointCount  Int      @default(0) @map("data_point_count") // 数据点数量
  lastUpdate      DateTime @default(now()) @map("last_update")
  date            String   // 日期（YYYY-MM-DD）

  @@unique([deviceId, date])
  @@map("device_stats")
}