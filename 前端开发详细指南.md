# 前端开发详细指南

## 一、技术栈说明

### 1.1 核心技术

```json
{
  "框架": "React 19.2.0",
  "语言": "TypeScript 5.9.3",
  "构建工具": "Vite 7.2.4",
  "UI组件库": "Ant Design 6.1.4",
  "状态管理": "Zustand 5.0.9",
  "路由": "React Router 7.12.0",
  "HTTP客户端": "Axios 1.13.2",
  "数据请求": "TanStack Query 5.90.16",
  "图表": "ECharts 6.0.0",
  "地图": "Leaflet 1.9.4",
  "实时通信": "Socket.io-client 4.8.3",
  "样式": "Tailwind CSS 4.1.18"
}
```

### 1.2 为什么选择这些技术

**React 19**:
- 最新版本，性能优化
- Server Components支持
- 自动批处理更新
- 并发渲染

**Zustand**:
- 轻量级（~1KB）
- API简单直观
- 无需Provider包裹
- TypeScript支持完善

**TanStack Query**:
- 自动缓存管理
- 后台自动刷新
- 乐观更新
- 离线支持

**Ant Design 6**:
- 企业级UI组件
- 国际化支持
- 主题定制
- 响应式设计

---

## 二、项目结构

### 2.1 目录结构

```
src/
├── assets/              # 静态资源
│   ├── images/         # 图片
│   └── fonts/          # 字体
├── components/          # 公共组件
│   ├── Layout/         # 布局组件
│   │   ├── MainLayout.tsx
│   │   ├── Sidebar.tsx
│   │   └── Header.tsx
│   ├── Charts/         # 图表组件
│   │   ├── LineChart.tsx
│   │   ├── BarChart.tsx
│   │   └── PieChart.tsx
│   ├── Common/         # 通用组件
│   │   ├── Loading.tsx
│   │   ├── ErrorBoundary.tsx
│   │   └── Empty.tsx
│   └── Forms/          # 表单组件
│       ├── MaterialForm.tsx
│       └── OrderForm.tsx
├── pages/              # 页面组件
│   ├── Dashboard/      # 仪表盘
│   ├── Materials/      # 物料管理
│   ├── Orders/         # 订单管理
│   ├── Production/     # 生产控制
│   └── Login/          # 登录页
├── stores/             # 状态管理
│   ├── authStore.ts    # 认证状态
│   ├── themeStore.ts   # 主题状态
│   └── websocketStore.ts # WebSocket状态
├── hooks/              # 自定义Hooks
│   ├── useAuth.ts      # 认证Hook
│   ├── useWebSocket.ts # WebSocket Hook
│   └── usePermission.ts # 权限Hook
├── utils/              # 工具函数
│   ├── api.ts          # API封装
│   ├── request.ts      # 请求拦截器
│   ├── format.ts       # 格式化函数
│   └── constants.ts    # 常量定义
├── types/              # TypeScript类型定义
│   ├── api.ts          # API类型
│   ├── models.ts       # 数据模型
│   └── common.ts       # 通用类型
├── styles/             # 样式文件
│   ├── global.css      # 全局样式
│   ├── variables.css   # CSS变量
│   └── themes/         # 主题样式
├── App.tsx             # 根组件
└── main.tsx            # 入口文件
```

---

## 三、核心功能实现

### 3.1 认证状态管理

```typescript
// stores/authStore.ts
import { create } from 'zustand';
import { persist } from 'zustand/middleware';

interface User {
  id: number;
  username: string;
  name: string;
  userType: string;
  siteId: number;
}

interface AuthState {
  user: User | null;
  token: string | null;
  isAuthenticated: boolean;
  login: (username: string, password: string) => Promise<void>;
  logout: () => void;
  refreshToken: () => Promise<void>;
}

export const useAuthStore = create<AuthState>()(
  persist(
    (set, get) => ({
      user: null,
      token: null,
      isAuthenticated: false,

      login: async (username: string, password: string) => {
        try {
          const response = await api.post('/auth/login', {
            username,
            password
          });

          const { user, token } = response.data.data;

          set({
            user,
            token,
            isAuthenticated: true
          });

          // 设置axios默认header
          api.defaults.headers.common['Authorization'] = `Bearer ${token}`;
        } catch (error) {
          throw error;
        }
      },

      logout: () => {
        set({
          user: null,
          token: null,
          isAuthenticated: false
        });

        // 清除axios header
        delete api.defaults.headers.common['Authorization'];

        // 跳转到登录页
        window.location.href = '/login';
      },

      refreshToken: async () => {
        try {
          const response = await api.post('/auth/refresh');
          const { token } = response.data.data;

          set({ token });
          api.defaults.headers.common['Authorization'] = `Bearer ${token}`;
        } catch (error) {
          get().logout();
        }
      }
    }),
    {
      name: 'auth-storage',
      partialize: (state) => ({
        user: state.user,
        token: state.token,
        isAuthenticated: state.isAuthenticated
      })
    }
  )
);
```

### 3.2 API请求封装

```typescript
// utils/request.ts
import axios from 'axios';
import { message } from 'antd';
import { useAuthStore } from '@/stores/authStore';

const request = axios.create({
  baseURL: import.meta.env.VITE_API_URL || 'http://localhost:3001/api',
  timeout: 30000
});

// 请求拦截器
request.interceptors.request.use(
  (config) => {
    const token = useAuthStore.getState().token;
    if (token) {
      config.headers.Authorization = `Bearer ${token}`;
    }
    return config;
  },
  (error) => {
    return Promise.reject(error);
  }
);

// 响应拦截器
request.interceptors.response.use(
  (response) => {
    return response.data;
  },
  async (error) => {
    if (error.response) {
      const { status, data } = error.response;

      switch (status) {
        case 401:
          // Token过期，尝试刷新
          try {
            await useAuthStore.getState().refreshToken();
            // 重试原请求
            return request(error.config);
          } catch (refreshError) {
            useAuthStore.getState().logout();
          }
          break;

        case 403:
          message.error('无权限访问');
          break;

        case 404:
          message.error('请求的资源不存在');
          break;

        case 500:
          message.error('服务器错误');
          break;

        default:
          message.error(data?.error?.message || '请求失败');
      }
    } else if (error.request) {
      message.error('网络错误，请检查网络连接');
    } else {
      message.error('请求配置错误');
    }

    return Promise.reject(error);
  }
);

export default request;
```

### 3.3 WebSocket连接管理

```typescript
// hooks/useWebSocket.ts
import { useEffect, useRef } from 'react';
import { io, Socket } from 'socket.io-client';
import { useAuthStore } from '@/stores/authStore';

interface UseWebSocketOptions {
  onConnect?: () => void;
  onDisconnect?: () => void;
  onError?: (error: Error) => void;
}

export const useWebSocket = (options: UseWebSocketOptions = {}) => {
  const socketRef = useRef<Socket | null>(null);
  const token = useAuthStore((state) => state.token);

  useEffect(() => {
    if (!token) return;

    // 创建连接
    const socket = io('ws://localhost:3001', {
      auth: { token }
    });

    socketRef.current = socket;

    // 连接成功
    socket.on('connect', () => {
      console.log('WebSocket connected');
      options.onConnect?.();
    });

    // 连接断开
    socket.on('disconnect', () => {
      console.log('WebSocket disconnected');
      options.onDisconnect?.();
    });

    // 连接错误
    socket.on('error', (error) => {
      console.error('WebSocket error:', error);
      options.onError?.(error);
    });

    // 清理
    return () => {
      socket.disconnect();
    };
  }, [token]);

  // 订阅房间
  const subscribe = (room: string, events: string[]) => {
    socketRef.current?.emit('subscribe', { room, events });
  };

  // 监听事件
  const on = (event: string, callback: (data: any) => void) => {
    socketRef.current?.on(event, callback);
  };

  // 取消监听
  const off = (event: string, callback?: (data: any) => void) => {
    socketRef.current?.off(event, callback);
  };

  return { subscribe, on, off };
};
```

### 3.4 数据请求Hook

```typescript
// hooks/useMaterials.ts
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import { message } from 'antd';
import api from '@/utils/request';

// 查询物料列表
export const useMaterials = (params?: any) => {
  return useQuery({
    queryKey: ['materials', params],
    queryFn: async () => {
      const response = await api.get('/materials', { params });
      return response.data;
    },
    staleTime: 5 * 60 * 1000, // 5分钟内数据不过期
    refetchInterval: 30 * 1000 // 30秒自动刷新
  });
};

// 创建物料
export const useCreateMaterial = () => {
  const queryClient = useQueryClient();

  return useMutation({
    mutationFn: async (data: any) => {
      const response = await api.post('/materials', data);
      return response.data;
    },
    onSuccess: () => {
      message.success('创建成功');
      // 刷新列表
      queryClient.invalidateQueries({ queryKey: ['materials'] });
    },
    onError: (error: any) => {
      message.error(error.message || '创建失败');
    }
  });
};

// 更新物料
export const useUpdateMaterial = () => {
  const queryClient = useQueryClient();

  return useMutation({
    mutationFn: async ({ id, data }: { id: number; data: any }) => {
      const response = await api.patch(`/materials/${id}`, data);
      return response.data;
    },
    onSuccess: () => {
      message.success('更新成功');
      queryClient.invalidateQueries({ queryKey: ['materials'] });
    }
  });
};

// 删除物料
export const useDeleteMaterial = () => {
  const queryClient = useQueryClient();

  return useMutation({
    mutationFn: async (id: number) => {
      await api.delete(`/materials/${id}`);
    },
    onSuccess: () => {
      message.success('删除成功');
      queryClient.invalidateQueries({ queryKey: ['materials'] });
    }
  });
};
```

---

## 四、页面组件实现

### 4.1 物料管理页面

```typescript
// pages/Materials/index.tsx
import React, { useState } from 'react';
import { Table, Button, Space, Modal, Form, Input, Select, InputNumber } from 'antd';
import { PlusOutlined, EditOutlined, DeleteOutlined } from '@ant-design/icons';
import { useMaterials, useCreateMaterial, useUpdateMaterial, useDeleteMaterial } from '@/hooks/useMaterials';

const MaterialsPage: React.FC = () => {
  const [isModalOpen, setIsModalOpen] = useState(false);
  const [editingMaterial, setEditingMaterial] = useState<any>(null);
  const [form] = Form.useForm();

  // 查询数据
  const { data, isLoading } = useMaterials();

  // 创建/更新
  const createMutation = useCreateMaterial();
  const updateMutation = useUpdateMaterial();
  const deleteMutation = useDeleteMaterial();

  // 表格列定义
  const columns = [
    {
      title: '物料名称',
      dataIndex: 'name',
      key: 'name'
    },
    {
      title: '类型',
      dataIndex: 'type',
      key: 'type',
      render: (type: string) => {
        const typeMap: any = {
          aggregate: '骨料',
          cement: '粉料',
          additive: '外加剂',
          water: '水'
        };
        return typeMap[type] || type;
      }
    },
    {
      title: '当前库存',
      dataIndex: 'currentStock',
      key: 'currentStock',
      render: (stock: number, record: any) => `${stock} ${record.unit}`
    },
    {
      title: '库存状态',
      key: 'status',
      render: (record: any) => {
        const percentage = (record.currentStock / record.capacity) * 100;
        if (percentage < 10) {
          return <span style={{ color: 'red' }}>严重不足</span>;
        } else if (percentage < 20) {
          return <span style={{ color: 'orange' }}>偏低</span>;
        } else {
          return <span style={{ color: 'green' }}>正常</span>;
        }
      }
    },
    {
      title: '操作',
      key: 'action',
      render: (record: any) => (
        <Space>
          <Button
            type="link"
            icon={<EditOutlined />}
            onClick={() => handleEdit(record)}
          >
            编辑
          </Button>
          <Button
            type="link"
            danger
            icon={<DeleteOutlined />}
            onClick={() => handleDelete(record.id)}
          >
            删除
          </Button>
        </Space>
      )
    }
  ];

  // 新增
  const handleAdd = () => {
    setEditingMaterial(null);
    form.resetFields();
    setIsModalOpen(true);
  };

  // 编辑
  const handleEdit = (material: any) => {
    setEditingMaterial(material);
    form.setFieldsValue(material);
    setIsModalOpen(true);
  };

  // 删除
  const handleDelete = (id: number) => {
    Modal.confirm({
      title: '确认删除',
      content: '确定要删除这个物料吗？',
      onOk: () => deleteMutation.mutate(id)
    });
  };

  // 提交表单
  const handleSubmit = async () => {
    try {
      const values = await form.validateFields();

      if (editingMaterial) {
        await updateMutation.mutateAsync({
          id: editingMaterial.id,
          data: values
        });
      } else {
        await createMutation.mutateAsync(values);
      }

      setIsModalOpen(false);
    } catch (error) {
      console.error('表单验证失败:', error);
    }
  };

  return (
    <div className="materials-page">
      <div className="page-header">
        <h1>物料管理</h1>
        <Button
          type="primary"
          icon={<PlusOutlined />}
          onClick={handleAdd}
        >
          新增物料
        </Button>
      </div>

      <Table
        columns={columns}
        dataSource={data?.items}
        loading={isLoading}
        rowKey="id"
        pagination={{
          total: data?.total,
          pageSize: 10,
          showSizeChanger: true,
          showTotal: (total) => `共 ${total} 条`
        }}
      />

      <Modal
        title={editingMaterial ? '编辑物料' : '新增物料'}
        open={isModalOpen}
        onOk={handleSubmit}
        onCancel={() => setIsModalOpen(false)}
        confirmLoading={createMutation.isPending || updateMutation.isPending}
      >
        <Form form={form} layout="vertical">
          <Form.Item
            name="name"
            label="物料名称"
            rules={[{ required: true, message: '请输入物料名称' }]}
          >
            <Input placeholder="请输入物料名称" />
          </Form.Item>

          <Form.Item
            name="type"
            label="物料类型"
            rules={[{ required: true, message: '请选择物料类型' }]}
          >
            <Select placeholder="请选择物料类型">
              <Select.Option value="aggregate">骨料</Select.Option>
              <Select.Option value="cement">粉料</Select.Option>
              <Select.Option value="additive">外加剂</Select.Option>
              <Select.Option value="water">水</Select.Option>
            </Select>
          </Form.Item>

          <Form.Item
            name="unit"
            label="计量单位"
            rules={[{ required: true, message: '请输入计量单位' }]}
          >
            <Input placeholder="如：吨、千克、升" />
          </Form.Item>

          <Form.Item
            name="lowThreshold"
            label="低库存阈值"
          >
            <InputNumber
              style={{ width: '100%' }}
              placeholder="请输入低库存阈值"
            />
          </Form.Item>

          <Form.Item
            name="unitPrice"
            label="单价"
          >
            <InputNumber
              style={{ width: '100%' }}
              placeholder="请输入单价"
              prefix="¥"
            />
          </Form.Item>
        </Form>
      </Modal>
    </div>
  );
};

export default MaterialsPage;
```

### 4.2 实时数据展示

```typescript
// pages/Dashboard/index.tsx
import React, { useEffect, useState } from 'react';
import { Card, Row, Col, Statistic } from 'antd';
import { useWebSocket } from '@/hooks/useWebSocket';
import LineChart from '@/components/Charts/LineChart';

const DashboardPage: React.FC = () => {
  const [stats, setStats] = useState({
    todayProduction: 0,
    activeOrders: 0,
    queueCount: 0,
    alarmCount: 0
  });

  const { subscribe, on } = useWebSocket();

  useEffect(() => {
    // 订阅实时数据
    subscribe('site_1', ['production', 'alarm', 'queue']);

    // 监听生产更新
    on('production:update', (data) => {
      setStats((prev) => ({
        ...prev,
        todayProduction: data.todayProduction
      }));
    });

    // 监听告警
    on('alarm:new', (data) => {
      setStats((prev) => ({
        ...prev,
        alarmCount: prev.alarmCount + 1
      }));
    });

    // 监听排队更新
    on('queue:update', (data) => {
      setStats((prev) => ({
        ...prev,
        queueCount: data.queueCount
      }));
    });
  }, []);

  return (
    <div className="dashboard-page">
      <Row gutter={16}>
        <Col span={6}>
          <Card>
            <Statistic
              title="今日产量"
              value={stats.todayProduction}
              suffix="m³"
            />
          </Card>
        </Col>
        <Col span={6}>
          <Card>
            <Statistic
              title="进行中订单"
              value={stats.activeOrders}
              suffix="个"
            />
          </Card>
        </Col>
        <Col span={6}>
          <Card>
            <Statistic
              title="排队车辆"
              value={stats.queueCount}
              suffix="辆"
            />
          </Card>
        </Col>
        <Col span={6}>
          <Card>
            <Statistic
              title="未处理告警"
              value={stats.alarmCount}
              suffix="条"
              valueStyle={{ color: stats.alarmCount > 0 ? '#cf1322' : undefined }}
            />
          </Card>
        </Col>
      </Row>

      <Row gutter={16} style={{ marginTop: 16 }}>
        <Col span={24}>
          <Card title="生产趋势">
            <LineChart />
          </Card>
        </Col>
      </Row>
    </div>
  );
};

export default DashboardPage;
```

---

## 五、性能优化

### 5.1 代码分割

```typescript
// App.tsx
import { lazy, Suspense } from 'react';
import { BrowserRouter, Routes, Route } from 'react-router-dom';
import Loading from '@/components/Common/Loading';

// 懒加载页面组件
const DashboardPage = lazy(() => import('@/pages/Dashboard'));
const MaterialsPage = lazy(() => import('@/pages/Materials'));
const OrdersPage = lazy(() => import('@/pages/Orders'));

function App() {
  return (
    <BrowserRouter>
      <Suspense fallback={<Loading />}>
        <Routes>
          <Route path="/dashboard" element={<DashboardPage />} />
          <Route path="/materials" element={<MaterialsPage />} />
          <Route path="/orders" element={<OrdersPage />} />
        </Routes>
      </Suspense>
    </BrowserRouter>
  );
}
```

### 5.2 虚拟列表

```typescript
// 大数据量表格使用虚拟滚动
import { Table } from 'antd';

<Table
  virtual
  scroll={{ y: 600 }}
  dataSource={largeDataset}
  columns={columns}
/>
```

### 5.3 防抖节流

```typescript
// hooks/useDebounce.ts
import { useEffect, useState } from 'react';

export const useDebounce = <T,>(value: T, delay: number = 500): T => {
  const [debouncedValue, setDebouncedValue] = useState<T>(value);

  useEffect(() => {
    const timer = setTimeout(() => {
      setDebouncedValue(value);
    }, delay);

    return () => {
      clearTimeout(timer);
    };
  }, [value, delay]);

  return debouncedValue;
};

// 使用
const [searchText, setSearchText] = useState('');
const debouncedSearch = useDebounce(searchText, 500);

useEffect(() => {
  // 执行搜索
  search(debouncedSearch);
}, [debouncedSearch]);
```

---

**文档版本**: V1.0  
**最后更新**: 2026年2月5日

